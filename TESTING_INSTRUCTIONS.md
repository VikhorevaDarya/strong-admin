# Инструкция по тестированию исправлений

## Что было исправлено

1. Токен теперь явно сохраняется в localStorage сразу после успешного логина
2. Упрощена логика checkAuth - теперь проверяется только наличие токена и model
3. Улучшено логирование для отладки

## Как протестировать

### Шаг 1: Очистите все данные

Откройте консоль браузера (F12) и выполните:

```javascript
localStorage.clear();
sessionStorage.clear();
location.reload();
```

### Шаг 2: Убедитесь что PocketBase запущен

```bash
# В корневой папке проекта
./pocketbase serve
```

### Шаг 3: Войдите в систему

1. Откройте http://localhost:3000
2. Введите email и пароль
3. В консоли должны увидеть:
   ```
   Login successful, session saved
   ```

### Шаг 4: Проверьте переключение между вкладками

1. Перейдите на "Товары" → "Склады" → "Товары"
2. Вы НЕ должны видеть сообщение `checkAuth failed`
3. Вы должны оставаться залогиненными

### Шаг 5: Проверьте обновление страницы

1. Нажмите F5 (обновить страницу)
2. В консоли должны увидеть:
   ```
   ✓ Session restored from localStorage
   ```
3. Вы должны остаться залогиненными

## Проверка localStorage

В консоли браузера выполните:

```javascript
// Проверка наличия токена
const auth = JSON.parse(localStorage.getItem('pocketbase_auth'));
console.log('Token:', auth.token);
console.log('User:', auth.model);
```

Вы должны увидеть токен и данные пользователя.

## Если проблема сохранилась

### Проверьте API Rules в PocketBase

1. Откройте http://127.0.0.1:8090/_/
2. Перейдите в коллекцию "products"
3. Вкладка "API Rules"
4. Убедитесь что ВСЕ правила установлены: `@request.auth.id != ""`

Повторите для коллекции "warehouses".

### Проверьте Network запросы

1. DevTools → Network
2. Переключитесь между вкладками
3. Найдите запросы к `/api/collections/products` или `/api/collections/warehouses`
4. Проверьте:
   - Статус должен быть **200**, не 401 или 403
   - В Headers должен быть `Authorization: eyJ...` (токен)

### Проверьте ошибки в консоли

Если видите красные ошибки в консоли:
- Сделайте скриншот
- Скопируйте текст ошибки
- Это поможет понять причину

## Ожидаемое поведение

✅ **Правильно:**
- Вход → переключение между вкладками → остаёмся залогиненными
- Обновление страницы → остаёмся залогиненными
- В консоли нет ошибок `checkAuth failed`

❌ **Неправильно:**
- При переходе между вкладками выкидывает на страницу входа
- Сообщение `checkAuth failed - no token or model in authStore`
- 401 или 403 ошибки в Network

## Дополнительная проверка

Если хотите убедиться что всё работает корректно:

1. Войдите в систему
2. Подождите 10 секунд
3. Откройте DevTools → Application → Local Storage → http://localhost:3000
4. Найдите ключ `pocketbase_auth`
5. Он должен содержать JSON с `token` и `model`

## Контрольный список

- [ ] Очистил localStorage и sessionStorage
- [ ] PocketBase запущен на порту 8090
- [ ] Вошёл в систему успешно
- [ ] Переключался между вкладками 3+ раз без вылогинивания
- [ ] Обновил страницу (F5) и остался залогиненным
- [ ] В консоли нет ошибок `checkAuth failed`
- [ ] В Network нет 401/403 ошибок
